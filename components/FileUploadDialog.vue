<script setup>
import { ref } from 'vue'
import * as XLSX from 'xlsx'

const props = defineProps({
  show: {
    type: Boolean,
    required: true,
  },
  title: {
    type: String,
    default: 'Upload File',
  },
  maxFileSize: {
    type: Number,
    default: 50 * 1024 * 1024, // 50MB
  },
  acceptedFormats: {
    type: String,
    default: '.xls,.xlsx',
  },
  uploadApi: {
    type: String,
    required: true,
  },
  requiredFields: {
    type: Array,
    default: () => [],
  },
  extraData: {
    type: Object,
    default: () => ({}),
  },
  redirectPath: {
    type: String,
    default: '',
  },
})

const emit = defineEmits(['update:show', 'uploadSuccess'])

const selectedFile = ref(null)
const error = ref('')
const uploading = ref(false)
const fileInput = ref(null)

const handleFileUpload = event => {
  error.value = ''

  const file = event.target?.files?.[0] || event
  if (!file) return

  if (file.size > props.maxFileSize) {
    error.value = "File size exceeds 50MB limit."
    
    return
  }

  selectedFile.value = file
}

const uploadFile = async () => {
  if (!selectedFile.value) return

  // Check if slot content exists by examining the DOM
  const bankSlotContent = document.querySelector('.bank-selection-slot-content')
  const isBankSelectionRequired = !!bankSlotContent
  
  // If bank selection is present but no value was passed in extraData.bank
  if (isBankSelectionRequired && !props.extraData.bank) {
    error.value = "Please select a bank before uploading."
    
    return
  }

  const reader = new FileReader()

  reader.onload = async e => {
    const data = new Uint8Array(e.target.result)
    const workbook = XLSX.read(data, { type: 'array' })
    const sheet = workbook.Sheets[workbook.SheetNames[0]]

    const json = XLSX.utils.sheet_to_json(sheet, {
      defval: "",
      raw: false,
    })

    if (!json || json.length === 0) {
      error.value = "Excel file is empty or unreadable."
      
      return
    }

    if (props.requiredFields.length > 0) {
      const keys = Object.keys(json[0] || {})
      const missingHeaders = props.requiredFields.filter(key => !keys.includes(key))
      
      if (missingHeaders.length > 0) {
        error.value = `Missing compulsory headers: ${missingHeaders.join(', ')}`
        
        return
      }
    }

    try {
      uploading.value = true
      
      const formData = new FormData()

      formData.append('file', selectedFile.value)
      
      // Add any extra data from props
      Object.entries(props.extraData).forEach(([key, value]) => {
        formData.append(key, value)
      })

      const res = await fetch(props.uploadApi, {
        method: 'POST',
        body: formData,
      })
      
      if (!res.ok) {
        const errorData = await res.json()
        throw new Error(errorData.error || 'Upload failed')
      }
      
      const data = await res.json()
      
      emit('uploadSuccess', {
        file: selectedFile.value,
        response: data,
      })
      
      closeDialog()
      
      if (props.redirectPath) {
        navigateTo(props.redirectPath)
      }
    } catch (err) {
      error.value = err.message || "Failed to upload data."
    } finally {
      uploading.value = false
    }
  }

  reader.readAsArrayBuffer(selectedFile.value)
}

const closeDialog = () => {
  selectedFile.value = null
  error.value = ''
  emit('update:show', false)
}
</script>

<template>
  <VDialog
    :model-value="show"
    max-width="550"
    persistent
    @update:model-value="$emit('update:show', $event)"
  >
    <VCard class="rounded-lg">
      <VCardTitle class="d-flex justify-space-between align-center pa-4 border-bottom">
        <span class="text-h6 font-weight-medium">{{ title }}</span>
        <VBtn
          icon
          variant="text"
          size="small"
          @click="closeDialog"
        >
          <VIcon icon="bx-x" />
        </VBtn>
      </VCardTitle>

      <VCardText class="pa-6">
        <!-- Bank Selection Slot - Add this new slot -->
        <div class="mb-6 bank-selection-slot-wrapper">
          <slot name="bank-selection" />
        </div>
        
        <!-- File Upload Area -->
        <VCard
          flat
          class="border-2 border-dashed rounded-lg pa-8 mb-6 text-center"
          :color="selectedFile ? 'primary' : 'default'"
          :class="{'border-primary': selectedFile}"
        >
          <div v-if="!selectedFile">
            <VIcon
              icon="bx-cloud-upload"
              size="42"
              class="mb-3 text-primary"
            />
            <h3 class="text-h6 mb-2">
              {{ title }}
            </h3>
            <p class="text-body-2 text-medium-emphasis mb-4">
              Click to browse or drag and drop your file
            </p>
            <VBtn 
              color="primary" 
              prepend-icon="bx-upload"
              @click="fileInput.click()"
            >
              Upload File
            </VBtn>
            <input
              ref="fileInput"
              type="file"
              :accept="acceptedFormats"
              class="d-none"
              @change="handleFileUpload"
            >
          </div>
          <div
            v-else
            class="py-2"
          >
            <div class="d-flex align-center">
              <VIcon
                icon="bx-file"
                size="32"
                color="primary"
                class="me-3"
              />
              <div class="text-start">
                <div class="text-subtitle-1 font-weight-medium">
                  {{ selectedFile.name }}
                </div>
                <div class="text-caption text-medium-emphasis">
                  {{ Math.round(selectedFile.size / 1024) }} KB
                  <VBtn
                    variant="text"
                    density="comfortable"
                    size="small"
                    color="error"
                    class="ms-2 text-caption"
                    @click="selectedFile = null; error = ''"
                  >
                    Remove
                  </VBtn>
                </div>
              </div>
            </div>
          </div>
        </VCard>

        <!-- Status Message -->
        <VCard
          v-if="error || uploading"
          :color="error ? 'error' : 'info'"
          variant="flat"
          class="mb-6 pa-4 rounded-lg"
        >
          <div class="d-flex align-center">
            <VIcon
              :icon="error ? 'bx-error-circle' : 'bx-loader bx-spin'"
              size="24"
              class="me-2"
            />
            <div>
              <div class="font-weight-medium">
                {{ error ? 'Missing data' : 'Uploading...' }}
              </div>
              <div
                v-if="error"
                class="text-body-2 mt-1"
              >
                {{ error }}
              </div>
            </div>
          </div>
        </VCard>

        <!-- Upload Rules -->
        <div class="mb-3">
          <div class="text-subtitle-1 font-weight-medium mb-3">
            Upload Rules:
          </div>
          
          <!-- Rule 1 -->
          <div class="d-flex align-start mb-2">
            <VIcon
              size="8"
              icon="bxs-bookmark-star"
              color="black"
              class="me-3 mt-2"
            />
            <span class="text-medium-emphasis">
              <span class="text-error font-weight-bold">Colored fields</span> are compulsory.
            </span>
          </div>
          
          <!-- Rule 2 -->
          <div class="d-flex align-start mb-2">
            <VIcon
              size="8"
              icon="bxs-bookmark-star"
              color="black"
              class="me-3 mt-2"
            />
            <span class="text-medium-emphasis">
              Ensure format matches <span class="text-primary font-weight-bold">sample uploaded file</span>.
            </span>
          </div>
          
          <!-- Rule 3 -->
          <div class="d-flex align-start mb-2">
            <VIcon
              size="8"
              icon="bxs-bookmark-star"
              color="black"
              class="me-3 mt-2"
            />
            <span class="text-medium-emphasis">
              Only <span class="text-primary font-weight-bold">.xls and .xlsx</span> files allowed.
            </span>
          </div>
          
          <!-- Rule 4 -->
          <div class="d-flex align-start mb-2">
            <VIcon
              size="8"
              icon="bxs-bookmark-star"
              color="black"
              class="me-3 mt-2"
            />
            <span class="text-medium-emphasis">
              Please make sure the file size must not exceed <span class="text-warning font-weight-bold">50 MB</span>
            </span>
          </div>
          
          <!-- Rule 5 -->
          <div class="d-flex align-start mb-2">
            <VIcon
              size="8"
              icon="bxs-bookmark-star"
              color="black"
              class="me-3 mt-2" 
            />
            <span class="text-medium-emphasis">
              Please don't upload <span class="text-error font-weight-bold">password protected</span> excel files.
            </span>
          </div>
          
          <!-- Rule 6 -->
          <div class="d-flex align-start">
            <VIcon
              size="8"
              icon="bxs-bookmark-star"
              color="black"
              class="me-3 mt-2"
            />
            <span class="text-medium-emphasis">
              Date format should be <span class="text-primary font-weight-bold">DD/MM/YYYY</span>.
            </span>
          </div>
        </div>
      </VCardText>

      <VCardActions class="pa-4 pt-0 d-flex justify-end gap-3">
        <VBtn
          variant="outlined"
          color="default"
          @click="closeDialog"
        >
          Cancel
        </VBtn>
        <VBtn
          color="primary"
          :loading="uploading"
          :disabled="!selectedFile"
          @click="uploadFile"
        >
          Upload
        </VBtn>
      </VCardActions>
    </VCard>
  </VDialog>
</template> 
